<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f5f5f5;
        text-align: center;
        padding: 20px;
        color: #333;
      }
      .card {
        background: white;
        padding: 30px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: 50px;
      }
      h1 { margin-bottom: 10px; font-size: 20px; }
      .container-id {
        font-size: 32px;
        font-weight: bold;
        color: #06C755;
        margin: 20px 0;
        display: block;
      }
      button {
        background-color: #06C755;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 30px;
        width: 100%;
        font-weight: bold;
        cursor: pointer;
      }
      button:disabled { background-color: #ccc; }
      #status { margin-top: 15px; font-size: 14px; color: #666; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Wada Lab Re:Turn System</h1>
      <div>この容器を貸し出しますか？</div>
      
      <span id="cid-display" class="container-id">...</span>
      
      <button id="btn-borrow" onclick="handleBorrow()">はい</button>
      <div id="status">読込中...</div>
    </div>

    <script>
      const MY_LIFF_ID = ""; 
      
      let containerId = "";

      // 1. 页面加载完成后执行
      window.onload = function() {
        // 从 URL 获取 containerId (?id=xxx)
        const urlParams = new URLSearchParams(window.location.search);
        // 如果是 LIFF 跳转过来的 URL，参数可能不一样，但我们先假设是标准 URL 参数
        containerId = urlParams.get('id'); 
        
        if (!containerId) {
          document.getElementById('status').innerText = "Error: Container ID not found";
          document.getElementById('cid-display').innerText = "???";
          document.getElementById('btn-borrow').disabled = true;
          return;
        }

        document.getElementById('cid-display').innerText = containerId;
        
        // 初始化 LIFF
        initializeLiff();
      };

      function initializeLiff() {
        liff.init({ liffId: MY_LIFF_ID })
          .then(() => {
            if (!liff.isLoggedIn()) {
              liff.login();
            } else {
              document.getElementById('status').innerText = "Ready";
            }
          })
          .catch((err) => {
            document.getElementById('status').innerText = "Failed to initialize LIFF: " + err;
          });
      }

      // 2. 点击按钮的处理
      function handleBorrow() {
        document.getElementById('btn-borrow').disabled = true;
        document.getElementById('btn-borrow').innerText = "Processing...";
        
        liff.getProfile().then(profile => {
          const userId = profile.userId;
          
          // ⭐️ 核心魔法：直接调用后端的 processBorrow 函数
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .processBorrow(userId, containerId);
            
        }).catch(err => {
           alert("User info not found: " + err);
        });
      }

      function onSuccess(response) {
        alert("貸出完了！");
        liff.closeWindow(); // 关闭窗口
      }

      function onFailure(error) {
        alert("問題があった！: " + error);
        document.getElementById('btn-borrow').disabled = false;
        document.getElementById('btn-borrow').innerText = "リトライ";
      }
    </script>